import{u as M,r as n,j as e,N as x,G as u,M as A}from"./index-D6kfz2qZ.js";const V=`
@keyframes progressPulse {
    0% { width: 10%; margin-left: 0%; }
    50% { width: 40%; margin-left: 30%; }
    100% { width: 10%; margin-left: 90%; }
}
`,Y=()=>{const{selectedGroup:l}=M(),[i,I]=n.useState([]),[S,k]=n.useState(!1),[a,z]=n.useState(null),[y,R]=n.useState([]),[D,E]=n.useState(!1),[o,j]=n.useState(null),[W,v]=n.useState(!1),[B,b]=n.useState(!1),[p,N]=n.useState(!1),[s,m]=n.useState(null),[c,T]=n.useState(null);n.useEffect(()=>{const r=window.electron.database.onRallyProgress(t=>{t.done?T(null):T({sent:t.sent,failed:t.failed,total:t.total})});return()=>r()},[]);const w=n.useCallback(async()=>{k(!0);try{const r=l?.id,t=await window.electron.database.getSessions(r);I(t),z(null),R([]),j(null)}catch(r){console.error("Failed to load sessions",r)}finally{k(!1)}},[l]);n.useEffect(()=>{w()},[w]),n.useEffect(()=>{const r=async()=>{const f=(await Promise.all(i.map(async d=>{if(!d.worldName||d.worldName==="Unknown World"){const h=d.worldId||d.location.split(":")[0];if(h&&h.startsWith("wrld_"))try{const g=await window.electron.getWorld(h);if(g.success&&g.world?.name)return{sessionId:d.sessionId,name:g.world.name}}catch(g){console.error("Failed to fetch world name for",h,g)}}return null}))).filter(d=>d!==null);f.length>0&&I(d=>d.map(h=>{const g=f.find(G=>G.sessionId===h.sessionId);return g?{...h,worldName:g.name}:h}))};i.length>0&&r()},[i]);const F=async r=>{z(r),E(!0),j(null);try{const t=await window.electron.database.getSessionEvents(r.filename);R(t||[])}catch(t){console.error("Failed to load events",t)}finally{E(!1)}},O=n.useMemo(()=>{const r={};return y.forEach(t=>{const f=t.actorDisplayName||"Unknown";r[f]=(r[f]||0)+1}),Object.entries(r).sort((t,f)=>f[1]-t[1])},[y]),C=n.useMemo(()=>o?y.filter(r=>r.actorDisplayName===o):y,[y,o]),L=()=>{v(!0)},P=async()=>{await window.electron.database.clearSessions()&&w(),v(!1)},U=()=>{a&&(m(null),b(!0))},H=async()=>{if(a){b(!1),N(!0),m(null);try{const r=await window.electron.database.rallyFromSession(a.filename);m(r)}catch(r){m({error:r.message||"Unknown error"})}finally{N(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:V}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(300px, 1fr) 2fr",gap:"1.5rem",height:"100%",paddingBottom:"100px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs("div",{style:{marginBottom:"1rem",display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-gradient",children:"Instance Database"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:l?`Viewing logs for ${l.name}`:"Viewing all local logs"})]}),e.jsx(x,{size:"sm",variant:"danger",onClick:L,style:{fontSize:"0.7rem"},children:"Clear DB"})]}),e.jsxs(u,{style:{flex:1,display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid rgba(255,255,255,0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("span",{style:{fontWeight:600},children:["Sessions (",i.length,")"]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:w,disabled:S,children:S?"...":"âŸ³"})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto"},children:[i.length===0&&!S&&e.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"rgba(255,255,255,0.3)"},children:"No logs found for this group."}),i.map(r=>e.jsxs("div",{onClick:()=>F(r),style:{padding:"1rem",borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",background:a?.sessionId===r.sessionId?"rgba(var(--color-primary-rgb), 0.1)":"transparent",borderLeft:a?.sessionId===r.sessionId?"3px solid var(--color-primary)":"3px solid transparent",transition:"background 0.2s"},children:[e.jsx("div",{style:{fontSize:"0.9rem",fontWeight:600,color:"white",marginBottom:"4px"},children:r.worldName||"Unknown World"}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"rgba(255,255,255,0.5)",display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:new Date(r.startTime).toLocaleString()}),r.groupId&&e.jsx("span",{style:{color:"var(--color-accent)"},children:"GRP"})]}),e.jsx("div",{style:{fontSize:"0.7rem",color:"rgba(255,255,255,0.3)",marginTop:"4px",fontFamily:"monospace",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:r.instanceId})]},r.sessionId))]})]})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:a?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1rem",height:"100%"},children:[e.jsxs(u,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0},children:a.worldName||a.worldId}),e.jsx("div",{style:{color:"var(--color-text-dim)",fontSize:"0.9rem",marginTop:"0.5rem"},children:new Date(a.startTime).toLocaleString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:"2rem",fontWeight:"bold",color:"var(--color-primary)",lineHeight:1},children:C.length}),e.jsx("div",{style:{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"1px"},children:o?`Events by ${o}`:"Total Events"}),o&&e.jsx(x,{size:"sm",variant:"ghost",style:{marginTop:"4px",fontSize:"0.7rem",padding:"2px 8px"},onClick:()=>j(null),children:"Clear Filter"})]})]}),e.jsxs("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid rgba(255,255,255,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(x,{size:"sm",variant:"primary",onClick:U,disabled:p,glow:!0,children:p?"ðŸ“¡ Sending Invites...":"ðŸ“£ Rally Users Here"}),p&&c?e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("div",{style:{flex:1,height:"8px",background:"rgba(255,255,255,0.1)",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.round(c.sent/c.total*100)}%`,height:"100%",background:c.failed>0?"linear-gradient(90deg, var(--color-primary), #f59e0b)":"var(--color-primary)",borderRadius:"4px",transition:"width 0.3s ease"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",color:"white",fontWeight:600,fontFamily:"monospace",minWidth:"80px"},children:["âœ“ ",c.sent,"/",c.total,c.failed>0&&e.jsxs("span",{style:{color:"#f59e0b"},children:[" (",c.failed," âœ—)"]})]})]}):p?e.jsx("span",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:"Preparing invites..."}):s?e.jsxs("div",{style:{fontSize:"0.85rem",padding:"4px 10px",borderRadius:"6px",background:s.error?"rgba(239, 68, 68, 0.15)":"rgba(34, 197, 94, 0.15)",color:s.error?"#ef4444":"#22c55e",display:"flex",alignItems:"center",gap:"0.5rem"},children:[s.error?e.jsxs(e.Fragment,{children:["âŒ ",s.error]}):e.jsxs(e.Fragment,{children:["âœ“ Sent ",s.invited," invite",s.invited!==1?"s":""]}),e.jsx("button",{onClick:()=>m(null),style:{background:"none",border:"none",color:"inherit",cursor:"pointer",fontSize:"1rem",lineHeight:1,opacity:.6},children:"Ã—"})]}):e.jsx("span",{style:{fontSize:"0.8rem",color:"var(--color-text-dim)"},children:"Invite all users from this session"})]})]}),e.jsxs("div",{style:{flex:1,display:"grid",gridTemplateColumns:"2fr 1fr",gap:"1rem",minHeight:0},children:[e.jsxs(u,{style:{display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.8rem",borderBottom:"1px solid rgba(255,255,255,0.1)",background:"rgba(0,0,0,0.2)",fontWeight:600,fontSize:"0.9rem"},children:o?`Activity: ${o}`:"Full Activity Log"}),e.jsx("div",{style:{flex:1,overflowY:"auto"},children:D?e.jsx("div",{style:{padding:"2rem",textAlign:"center"},children:"Loading events..."}):e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"0.85rem"},children:[e.jsx("thead",{style:{background:"rgba(255,255,255,0.05)",color:"var(--color-text-dim)",textAlign:"left"},children:e.jsxs("tr",{children:[e.jsx("th",{style:{padding:"0.8rem"},children:"Time"}),e.jsx("th",{style:{padding:"0.8rem"},children:"Type"}),e.jsx("th",{style:{padding:"0.8rem"},children:"User"}),e.jsx("th",{style:{padding:"0.8rem"},children:"Details"})]})}),e.jsx("tbody",{children:C.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,style:{padding:"1rem",textAlign:"center",color:"gray"},children:"No events found"})}):C.map((r,t)=>e.jsxs("tr",{style:{borderBottom:"1px solid rgba(255,255,255,0.02)"},children:[e.jsx("td",{style:{padding:"0.6rem 0.8rem",color:"rgba(255,255,255,0.5)",whiteSpace:"nowrap"},children:new Date(r.timestamp).toLocaleTimeString([],{hour12:!1})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem"},children:e.jsx(_,{type:r.type})}),e.jsx("td",{style:{padding:"0.6rem 0.8rem",fontWeight:500},children:r.actorDisplayName}),e.jsx("td",{style:{padding:"0.6rem 0.8rem",color:"rgba(255,255,255,0.6)",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:JSON.stringify(r.details||"")})]},t))})]})})]}),e.jsxs(u,{style:{display:"flex",flexDirection:"column",padding:0,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.8rem",borderBottom:"1px solid rgba(255,255,255,0.1)",background:"rgba(0,0,0,0.2)",fontWeight:600,fontSize:"0.9rem"},children:"Participants"}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"0.5rem"},children:O.map(([r,t])=>e.jsxs("div",{onClick:()=>j(r===o?null:r),style:{display:"flex",justifyContent:"space-between",padding:"0.5rem",borderBottom:"1px solid rgba(255,255,255,0.02)",cursor:"pointer",background:o===r?"rgba(var(--color-primary-rgb), 0.2)":"transparent",borderRadius:"6px",transition:"background 0.2s"},children:[e.jsx("span",{style:{fontSize:"0.9rem",color:o===r?"white":"inherit"},children:r}),e.jsx("span",{style:{fontSize:"0.8rem",background:"rgba(255,255,255,0.1)",borderRadius:"10px",padding:"0 6px"},children:t})]},r))})]})]})]}):e.jsxs(u,{style:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},children:[e.jsx("div",{style:{fontSize:"3rem",opacity:.2},children:"ðŸ“‚"}),e.jsx("div",{style:{marginTop:"1rem",color:"var(--color-text-dim)"},children:"Select a session to view details"})]})}),e.jsx(A,{isOpen:W,onClose:()=>v(!1),title:"Clear Database",width:"400px",footer:e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"ghost",onClick:()=>v(!1),children:"Cancel"}),e.jsx(x,{variant:"danger",onClick:P,glow:!0,children:"Yes, Clear Everything"})]}),children:e.jsxs("div",{style:{color:"var(--color-text-secondary)",lineHeight:"1.6"},children:["Are you sure you want to clear the entire instance database?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{color:"#ef4444",fontWeight:500},children:"This cannot be undone."}),e.jsx("br",{}),"All logged sessions and event history will be permanently deleted.",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.85rem",color:"var(--color-text-dim)",fontStyle:"italic"},children:"Note: If you are currently playing VRChat, you will need to rejoin the world to begin populating the new database."})]})}),e.jsx(A,{isOpen:B,onClose:()=>{b(!1),m(null)},title:"ðŸ“£ Rally Previous Session",width:"450px",footer:e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"ghost",onClick:()=>{b(!1),m(null)},children:s?"Close":"Cancel"}),!s&&e.jsx(x,{variant:"primary",onClick:H,disabled:p,glow:!0,children:p?"Sending Invites...":"Send Invites"})]}),children:e.jsx("div",{style:{color:"var(--color-text-secondary)",lineHeight:"1.6"},children:s?s.error?e.jsxs("div",{style:{color:"#ef4444"},children:[e.jsx("strong",{children:"Error:"})," ",s.error]}):e.jsxs("div",{children:[e.jsx("div",{style:{color:"#22c55e",fontWeight:600,fontSize:"1.1rem",marginBottom:"0.5rem"},children:"âœ“ Rally Complete!"}),e.jsxs("p",{style:{margin:0},children:["Sent ",e.jsx("strong",{children:s.invited})," invite",s.invited!==1?"s":"",s.failed&&s.failed>0&&e.jsxs("span",{style:{color:"#f59e0b"},children:[" (",s.failed," failed)"]})]}),s.errors&&s.errors.length>0&&e.jsx("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#f59e0b"},children:s.errors.join(", ")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{style:{margin:0},children:["This will invite all users from ",e.jsx("strong",{children:a?.worldName||"this session"})," to your current instance."]}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.9rem",color:"var(--color-text-dim)"},children:"Users already in your instance will be skipped. Invites are rate-limited to avoid VRChat throttling."})]})})})]})]})},_=({type:l})=>{if(!l)return e.jsx("span",{style:{color:"gray"},children:"Unknown"});let i="gray";return l==="JOIN"&&(i="#22c55e"),l==="LEAVE"&&(i="#ef4444"),l==="AVATAR_CHANGE"&&(i="#3b82f6"),l==="WORLD_NAME_UPDATE"&&(i="#eab308"),l==="LOCATION_CHANGE"&&(i="#8b5cf6"),e.jsx("span",{style:{color:i,background:`${i}20`,padding:"2px 6px",borderRadius:"4px",fontSize:"0.7rem",fontWeight:700},children:l.replace("_"," ")})};export{Y as DatabaseView};
